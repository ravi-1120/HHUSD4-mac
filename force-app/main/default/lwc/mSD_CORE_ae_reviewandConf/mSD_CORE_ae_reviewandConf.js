import AECANCER from '@salesforce/label/c.MSD_CORE_ae_AE_Cancer';
import AEDESCRIPTION from '@salesforce/label/c.MSD_CORE_ae_AE_Description';
import ADDRESS from '@salesforce/label/c.MSD_CORE_ae_Address';
import ADVERSEEVENTFORTHISPATIENT from '@salesforce/label/c.MSD_CORE_ae_Adverse_Event_for_this_patient_to_Merck';
import BIRTHDEFECT from '@salesforce/label/c.MSD_CORE_ae_Birth_Defect';
import CATALOGNUMBER from '@salesforce/label/c.MSD_CORE_ae_Catalog_Number';
import CITY from '@salesforce/label/c.MSD_CORE_ae_City';
import CONCOMITANTMEDICATION from '@salesforce/label/c.MSD_CORE_ae_Concomitant_Medication';
import COUNTRY from '@salesforce/label/c.MSD_CORE_ae_Country';
import DECHALLENGE from '@salesforce/label/c.MSD_CORE_ae_Dechallenge';
import DELETE from '@salesforce/label/c.MSD_CORE_ae_Delete';
import DISABILITYORINCAPACITY from '@salesforce/label/c.MSD_CORE_ae_Disability_Or_Incapacity';
import DOSEFREQUENCY from '@salesforce/label/c.MSD_CORE_ae_Dose_Frequency';
import DOWNLOAD from '@salesforce/label/c.MSD_CORE_ae_Download';
import EDIT from '@salesforce/label/c.MSD_CORE_ae_Edit';
import EMAIL1 from '@salesforce/label/c.MSD_CORE_ae_Email';
import EMAIL from '@salesforce/label/c.MSD_CORE_ae_Email_Address';
import EMPLOYEEID from '@salesforce/label/c.MSD_CORE_ae_Employee_ID';
import EVENTCASENUMBER from '@salesforce/label/c.MSD_CORE_ae_Event_Case_number_if_available';
import EXPIRATIONDATE from '@salesforce/label/c.MSD_CORE_ae_Expiration_Date';
import FILENAME from '@salesforce/label/c.MSD_CORE_ae_File_Name';
import FILESIZE from '@salesforce/label/c.MSD_CORE_ae_File_Size';
import FILESUPLOAD from '@salesforce/label/c.MSD_CORE_ae_Files_Uploaded';
import FIRSTNAME from '@salesforce/label/c.MSD_CORE_ae_First_Name';
import HEALTHCAREPROVIDERINFORMATION from '@salesforce/label/c.MSD_CORE_ae_Healthcare_Provider_Information';
import INDICATION from '@salesforce/label/c.MSD_CORE_ae_Indication';
import ISPATIENTPREGNANT from '@salesforce/label/c.MSD_CORE_ae_Is_Patient_Pregnant';
import LASTNAME from '@salesforce/label/c.MSD_CORE_ae_Last_Name';
import LOTNUMBER from '@salesforce/label/c.MSD_CORE_ae_Lot_Number';
import MODELNUMBER from '@salesforce/label/c.MSD_CORE_ae_Model_Number';
import PSPCOMPANY from '@salesforce/label/c.MSD_CORE_ae_PSP_Company';
import PSPCOMPANYOTHER from '@salesforce/label/c.MSD_CORE_ae_PSP_Company_Other';
import PSPNUMBER from '@salesforce/label/c.MSD_CORE_ae_PSP_Number';
import PSPNUMBEROTHER from '@salesforce/label/c.MSD_CORE_ae_PSP_Number_Other';
import PSPPROGRAMNAME from '@salesforce/label/c.MSD_CORE_ae_PSP_Program_Name';
import PSPPROGRAMNAMEOTHER from '@salesforce/label/c.MSD_CORE_ae_PSP_Program_Name_Other';
import PATIENTAGE from '@salesforce/label/c.MSD_CORE_ae_Patient_Age';
import PATIENTDATEOFBIRTH from '@salesforce/label/c.MSD_CORE_ae_Patient_Date_of_Birth';
import PATIENTDIE from '@salesforce/label/c.MSD_CORE_ae_Patient_Die';
import PATIENTFIRSTNAME from '@salesforce/label/c.MSD_CORE_ae_Patient_First_Name';
import PATIENTGENDER from '@salesforce/label/c.MSD_CORE_ae_Patient_Gender';
import PATIENTID from '@salesforce/label/c.MSD_CORE_ae_Patient_ID';
import PATIENTINFORMATION from '@salesforce/label/c.MSD_CORE_ae_Patient_Information';
import PATIENTLASTNAME from '@salesforce/label/c.MSD_CORE_ae_Patient_Last_Name';
import PATIENTOVERDOSE from '@salesforce/label/c.MSD_CORE_ae_Patient_Overdose';
import FIRSTEXPERIENCE from '@salesforce/label/c.MSD_CORE_ae_Patient_first_experience_this_Adverse_Event';
import PERMISSIONTOCONTACTHCP from '@salesforce/label/c.MSD_CORE_ae_Permission_To_Contact_hcp';
import PERMISSIONTOCONTACT from '@salesforce/label/c.MSD_CORE_ae_Permission_to_Contact';
import PERTINENTMEDICALHISTORY from '@salesforce/label/c.MSD_CORE_ae_Pertinent_Medical_History';
import PHONE from '@salesforce/label/c.MSD_CORE_ae_Phone';
import FACILITYNAME from '@salesforce/label/c.MSD_CORE_ae_Practice_or_Facility_Name';
import PREGNANCYGESTATION from '@salesforce/label/c.MSD_CORE_ae_Pregnancy_Gestation_LMP';
import PRESENTSERIOUSCRITERIA from '@salesforce/label/c.MSD_CORE_ae_Present_Serioous_Criteria';
import PRESENTSTATUS from '@salesforce/label/c.MSD_CORE_ae_Present_Status';
import PRODUCTNAME from '@salesforce/label/c.MSD_CORE_ae_Product_Name';
import PROLONGEDHOSPITAL from '@salesforce/label/c.MSD_CORE_ae_Prolonged_Hospital';
import RECHALLENGE from '@salesforce/label/c.MSD_CORE_ae_Rechallenge';
import RECOVERYDATE from '@salesforce/label/c.MSD_CORE_ae_Recovery_Date';
import REPORTINGMULTIPLEPATIENTS from '@salesforce/label/c.MSD_CORE_ae_Reporting_Multiple_patients';
import REVIEWDETAILS from '@salesforce/label/c.MSD_CORE_ae_Review_Details';
import ROUTEOFADMINISTRATION from '@salesforce/label/c.MSD_CORE_ae_Route_of_Administration';
import SERIALNUMBER from '@salesforce/label/c.MSD_CORE_ae_Serial_Number';
import SOUGHTMEDICAL from '@salesforce/label/c.MSD_CORE_ae_Sought_Medical';
import STATE from '@salesforce/label/c.MSD_CORE_ae_State';
import THERAPYDISCONTINUED from '@salesforce/label/c.MSD_CORE_ae_Therapy_Discontinued';
import THERAPYENDDATE from '@salesforce/label/c.MSD_CORE_ae_Therapy_End_Date';
import THERAPYSTARTDATE from '@salesforce/label/c.MSD_CORE_ae_Therapy_Start_Date';
import THREATNINGILLNESS from '@salesforce/label/c.MSD_CORE_ae_Threatning_Illness';
import HEALTHCAREPROVIDER from '@salesforce/label/c.MSD_CORE_ae_Type_of_HealthCare_Provider';
import UNIQUEIDENTIFIER from '@salesforce/label/c.MSD_CORE_ae_Unique_Identifier';
import WASTREATMENT from '@salesforce/label/c.MSD_CORE_ae_Was_Treatment';
import WHOADMINISTEREDTHEPRODUCT from '@salesforce/label/c.MSD_CORE_ae_Who_administered_the_product';
import YESCAUSEOFDEATH from '@salesforce/label/c.MSD_CORE_ae_Yes_Cause_of_Death';
import YESDATEOFDEATH from '@salesforce/label/c.MSD_CORE_ae_Yes_Date_of_Death';
import YESTREATMENT from '@salesforce/label/c.MSD_CORE_ae_Yes_Treatment';
import ZIPCODE from '@salesforce/label/c.MSD_CORE_ae_Zip_Code';
import AWAREOFTHISAE from '@salesforce/label/c.MSD_CORE_ae_aware_of_this_AE';
import { LightningElement, api, track } from 'lwc';
// import PracticeorFacilityName from '@salesforce/label/c.MSD_CORE_ae_Practice_or_Facility_Name';
import createAeCase from '@salesforce/apex/MSD_CORE_ae_CaseController.createAeCase';
import verifyRecaptcha from '@salesforce/apex/MSD_CORE_ae_reCAPTCHA.verifyRecaptcha';
import ADDRESSLINE2 from '@salesforce/label/c.MSD_CORE_ae_Address_Line2';
import AreYouPatient from '@salesforce/label/c.MSD_CORE_ae_Are_You_Patient';
import credential from '@salesforce/label/c.MSD_CORE_ae_Credential';
import DETAILSTOSHARE from '@salesforce/label/c.MSD_CORE_ae_Details_To_Share';
import DRUGREACTIONS from '@salesforce/label/c.MSD_CORE_ae_Drug_Reactions';
import IsReporterHCPSame from '@salesforce/label/c.MSD_CORE_ae_Hcp_Information_Noted';
import HISTORYTOSHARE from '@salesforce/label/c.MSD_CORE_ae_History_To_Share';
import LABDIAGNOSTICS from '@salesforce/label/c.MSD_CORE_ae_Lab_Diagnostics';
import NAMEOFAGENT from '@salesforce/label/c.MSD_CORE_ae_Name_Of_Agent';
import REPORTERINFORMATION from '@salesforce/label/c.MSD_CORE_ae_Reporter_Information';
import SERIOUSCRITERIA from '@salesforce/label/c.MSD_CORE_ae_Serious_Criteria';
import SUBMITBUTTON from '@salesforce/label/c.MSD_CORE_ae_Submit';
import TypeOfRoleFacility from '@salesforce/label/c.MSD_CORE_ae_Type_Of_Role_Facility';
import TYPEHEALTHCARE from '@salesforce/label/c.MSD_CORE_ae_Type_of_HealthCare_Provider';
import WhatTypeOfHealthcare from '@salesforce/label/c.MSD_CORE_ae_What_Type_Of_Healthcare';
import WhoReportedAe from '@salesforce/label/c.MSD_CORE_ae_Who_Reported_AE';

export default class MSD_CORE_ae_reviewandConf extends LightningElement {
    label = {
        WhoReportedAe,
        IsReporterHCPSame,
        HISTORYTOSHARE,
        ADDRESSLINE2,
        NAMEOFAGENT,
        REPORTERINFORMATION,
        SERIOUSCRITERIA,
        DETAILSTOSHARE,
        PRODUCTNAME,
        DOSEFREQUENCY,
        LOTNUMBER,
        EXPIRATIONDATE,
        UNIQUEIDENTIFIER,
        MODELNUMBER,
        CATALOGNUMBER,
        SERIALNUMBER,
        WHOADMINISTEREDTHEPRODUCT,
        PATIENTINFORMATION,
        PATIENTFIRSTNAME,
        PATIENTLASTNAME,
        PATIENTDATEOFBIRTH,
        PATIENTAGE,
        PATIENTGENDER,
        ISPATIENTPREGNANT,
        PREGNANCYGESTATION,
        FILESUPLOAD,
        FILENAME,
        FILESIZE,
        DOWNLOAD,
        DELETE,
        EMPLOYEEID,
        EDIT,
        REVIEWDETAILS,
        FIRSTNAME,
        LASTNAME,
        PHONE,
        EMAIL,
        PSPPROGRAMNAME,
        PSPPROGRAMNAMEOTHER,
        PSPCOMPANY,
        PSPCOMPANYOTHER,
        PSPNUMBER,
        PSPNUMBEROTHER,
        PATIENTID,
        EMAIL1,
        ADDRESS,
        CITY,
        ZIPCODE,
        STATE,
        COUNTRY,
        ADVERSEEVENTFORTHISPATIENT,
        EVENTCASENUMBER,
        HEALTHCAREPROVIDER,
        TYPEHEALTHCARE,
        FACILITYNAME,
        HEALTHCAREPROVIDERINFORMATION,
        PERMISSIONTOCONTACT,
        REPORTINGMULTIPLEPATIENTS,
        AEDESCRIPTION,
        AWAREOFTHISAE,
        FIRSTEXPERIENCE,
        PATIENTDIE,
        YESCAUSEOFDEATH,
        YESDATEOFDEATH,
        PROLONGEDHOSPITAL,
        THREATNINGILLNESS,
        DISABILITYORINCAPACITY,
        BIRTHDEFECT,
        AECANCER,
        PATIENTOVERDOSE,
        PRESENTSERIOUSCRITERIA,
        INDICATION,
        ROUTEOFADMINISTRATION,
        THERAPYSTARTDATE,
        THERAPYDISCONTINUED,
        THERAPYENDDATE,
        DECHALLENGE,
        RECHALLENGE,
        SOUGHTMEDICAL,
        WASTREATMENT,
        YESTREATMENT,
        PRESENTSTATUS,
        RECOVERYDATE,
        CONCOMITANTMEDICATION,
        PERTINENTMEDICALHISTORY,
        DRUGREACTIONS,
        LABDIAGNOSTICS,
        // PracticeorFacilityName,
        SUBMITBUTTON,
        credential,
        TypeOfRoleFacility,
        WhatTypeOfHealthcare,
        AreYouPatient,
        PERMISSIONTOCONTACTHCP
    }
    @api caseDetails;
    @api stageNames;

    @track stage2 = {};
    @track stage3 = {};
    @track stage4 = [];
    @track stage5 = {};
    @track stage6 = {};
    @track activeSections = ['1', '2', '3', '4', '5', '6'];
    showWarning = false;
    caseNumber = '';
    errorMessage = '';
    uploadedFilesList = null;
    isProgramOtherFieldDisabled = false;
    isCompanyOtherFieldDisabled = false;
    isNumberOtherFieldDisabled = false;
    isCaseNumber = false;
    isLoading = false;
    isFemale;
    isRepFemale;
    ifPregnantYes;
    ifRepPregnantYes;
    token = '';
    recaptchaResponseCount = 0;
    isSubmitting = false;

    get ifHCP() {
        return (this.stage3.ReporterType === 'INDIV HEALTHCARE PROF');
    }
    get ifHBP(){
        return (this.caseDetails.stage3['ReporterType'] === 'HEALTHCARE BUSINESS PROF');
    }
    get showHCPFields() {
        if (this.stage3.ReporterType === 'INDIV HEALTHCARE PROF' && this.stage3.ReporterHCPSame === 'No') {
            return true;
        } else if (this.stage3.ReporterType !== 'INDIV HEALTHCARE PROF') {
            return true;
        }
        return false;
    }
    get isMerckEmployee() {
        let userChoice = this.caseDetails.stage1['userChoice'];
        return userChoice === 'Merck Employee';
    }
    get isPSP() {
        let userChoice = this.caseDetails.stage1['userChoice'];
        return userChoice === 'PSP Representative';
    }
    get isHCP() {
        let userChoice = this.caseDetails.stage1['userChoice'];
        return userChoice === 'Healthcare Professional';
    }
    get ifPatient(){
        let userChoice = this.caseDetails.stage1['userChoice'];
        return this.caseDetails.stage3['ReporterType'] === 'Patient' && this.caseDetails.stage3['ReporterType']!== null && userChoice !== 'Healthcare Professional';
    }
    get isHCPType() {
        let licensedHCP = this.caseDetails.stage2['licensedHCP'];
        return licensedHCP=='Licensed Healthcare Professional';
    }
    get isHBPType() {
        let licensedHCP = this.caseDetails.stage2['licensedHCP'];
        return licensedHCP=='Healthcare Office Worker or Facility Personnel';
    }
    get FieldBased(){
        let FieldBased = this.caseDetails.stage2['FieldBased'];
        return FieldBased=='yes';
    }
    get NonFieldBased(){
        let FieldBased = this.caseDetails.stage2['FieldBased'];
        return FieldBased=='no';
    } 
    get firstReport(){
        let firstReport = this.caseDetails.stage3['firstReport'];
        return firstReport == 'No';
    }
    get employeeId() {
        return this.FieldBased ? this.caseDetails.stage2.WinId : this.caseDetails.stage2.NEmployeeId;
    }
    
    get firstName() {
        return this.FieldBased ? this.caseDetails.stage2.MaskedFirstName : this.caseDetails.stage2.NFirstName;
    }
    get lastName() {
        return this.FieldBased ? this.caseDetails.stage2.LastName : this.caseDetails.stage2.NName;
    }
    
    get phone() {
        return this.FieldBased ? this.caseDetails.stage2.MaskedPhone : this.caseDetails.stage2.NempPhone;
    }
    
    get email() {
        return this.FieldBased ? this.caseDetails.stage2.MaskedEmail : this.caseDetails.stage2.NempEmail;
    }

    get country() {
        return this.caseDetails.stage2.NempCountry;
    }
    
    get stage2Label() {
        return this.stageNames && this.stageNames[1] ? this.stageNames[1].label : 'Default Label';
    }
    get stage3Label() {
        return this.stageNames && this.stageNames[2] ? this.stageNames[2].label : 'Default Label';
    }
    get stage4Label() {
        return this.stageNames && this.stageNames[3] ? this.stageNames[3].label : 'Default Label';
    }
    get stage5Label() {
        return this.stageNames && this.stageNames[4] ? this.stageNames[4].label : 'Default Label';
    }
    get stage6Label() {
        return this.stageNames && this.stageNames[5] ? this.stageNames[5].label : 'Default Label';
    }
    get showStage6() {
        return this.stage5.MPI === 'No' || this.isHCP;
    }
    get hasUploadedFiles() {
        return this.uploadedFilesList && this.uploadedFilesList.length > 0;
    }
    get PatientsHC() {
        let PatientsHC = this.caseDetails.stage3['PatientsHC'];
        return PatientsHC=='Yes';
    }
    get PatientReporter(){
        let PatientReporter = this.caseDetails.stage3['isPatientReporter'];
        return PatientReporter=='Yes';
    }


    connectedCallback() {
        this.token = '';
        this.handleCaseDetail();
        document.addEventListener('grecaptchaVerified', this.handleRecaptchaResponse.bind(this));
        
    }
    disconnectedCallback() {
        document.removeEventListener('grecaptchaVerified', this.handleRecaptchaResponse.bind(this));
    }
    handleCaseDetail() {
        this.javascriptRecaptchaVerificationResult = {};
        this.stage2 = { ...this.caseDetails.stage2 };
        this.stage3 = { ...this.caseDetails.stage3 };
        this.stage4 = [...this.caseDetails.stage4];
        this.stage5 = { ...this.caseDetails.stage5 };
        this.stage6 = { ...this.caseDetails.stage6 };
        // console.log('Should we Prepopulate the fields:', JSON.stringify(this.PatientsHC));
        if (this.PatientsHC) {
            const fieldMapping = {
                hcpFirstName: 'HCPFirstName',
                hcpLastName: 'HCPLastName',
                hcpPhone: 'HCPPhone',
                hcpEmail: 'HCPEmail',
                hcpAddress: 'HCPAddress',
                hcpAddressLine2: 'HCPAddressLine2',
                hcpCity: 'HCPCity',
                hcpZip: 'HCPZip',
                hcpCountry: 'HCPCountry',
                HCPType: 'HCPType',
                hcpState: 'HCPState',
                hcpCredential: 'HCPCredential',
                hcpFacilityName: 'HCPFacilityName',
            };
            for (const [stage2Field, stage3Field] of Object.entries(fieldMapping)) {
                if (this.stage2[stage2Field]) {
                    this.stage3[stage3Field] = this.stage2[stage2Field];
                } else if (!this.stage2[stage2Field]) {
                    this.stage2[stage2Field] = this.stage3[stage3Field];
                }
            }
        }

        if (this.PatientReporter) {
            const fieldMapping = {
                hcpFirstName: 'PatientFirstName',
                hcpLastName: 'PatientLastName',
            };
            for (const [stage2Field, stage3Field] of Object.entries(fieldMapping)) {
                if (this.stage2[stage2Field]) {
                    this.stage3[stage3Field] = this.stage2[stage2Field];
                } 
                  else if (!this.stage2[stage2Field]) {
                    this.stage2[stage2Field] = this.stage3[stage3Field];
                }
            }
        }
        if (this.isPSP) {
            if (this.stage2['PSPProgramName'] != null) {
                this.updatePspOtherFields('PSPProgramName', this.stage2['PSPProgramName']);
            }
            if (this.stage2['PSPNumber'] != null) {
                this.updatePspOtherFields('PSPNumber', this.stage2['PSPNumber']);
            };
            if (this.stage2['PSPCompany'] != null) {
                this.updatePspOtherFields('PSPCompany', this.stage2['PSPCompany']);
            };
        }
        if (this.stage2.uploadedFiles) {
            this.uploadedFilesList = [...this.stage2.uploadedFiles];
        }
        if (this.stage5.CAD) {
            const localDateStr = this.stage5.CAD + 'T00:00';
            if (!isNaN(Date.parse(localDateStr))) {
                const cadDate = new Date(localDateStr);
                this.stage5.CAD = cadDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit'
                });
            } else {
                console.error('Invalid date:', this.stage5.CAD);
                this.stage5.CAD = '';
            }
        } else {
            this.stage5.CAD = '';
        }

        this.isFemale = this.stage3.isFemale || false;
        this.isRepFemale = this.stage3.isRepFemale || false;
        this.ifRepPregnantYes = this.stage3.ifRepPregnantYes || false;
        this.ifPregnantYes = this.stage3.ifPregnantYes || false;
        this.istreatment = this.stage6.istreatment || false;
        this.istherapy = this.stage6.istherapy || false;
        this.isRecovered = this.stage6.isRecovered || false;
        this.isyes = this.stage6.isyes || false;
    }

    toggleEdit(event) {
        const section = event.currentTarget.dataset.section;
        this.dispatchEvent(new CustomEvent('edit', { detail: section }));
    }

    handleShowMainContent() {
        this.showWarning = false;
        const Assessment = new CustomEvent('change', {
            detail: 'New'
        });
        this.dispatchEvent(Assessment);
    }

    handleSubmit() {
        if (!this.isSubmitting) { // Check if already submitting
            this.isSubmitting = true; // Set the flag to true
            document.dispatchEvent(new CustomEvent('grecaptchaExecute', { detail: { action: 'submit_case' } }));
        }
    }
    
    handleRecaptchaResponse(event) {
        if (this.isSubmitting) {
            console.log('Recaptcha response received:', event.detail.response);
            this.token = event.detail.response;
            this.recaptchaResponseCount++;
            console.log('Recaptcha response count:', this.recaptchaResponseCount);
            this.isLoading = true;
            if (this.token) {
                verifyRecaptcha({ response: this.token })
                    .then(javascriptRecaptchaVerificationResult => {
                        console.log('reCAPTCHA verification result:', JSON.stringify(javascriptRecaptchaVerificationResult));
                        if (javascriptRecaptchaVerificationResult.isSuccess && javascriptRecaptchaVerificationResult.score >= 0.7) {
                            this.isLoading = true;
                            this.submitCase();
                        } else {
                            this.isLoading = false;
                            this.errorMessage = 'Failed to verify reCAPTCHA. Please try again.';
                            console.error('reCAPTCHA validation failed.');
                            this.isSubmitting = false; // Reset the flag
                        }
                    })
                    .catch(error => {
                        this.isLoading = false;
                        this.errorMessage = 'There was an error processing the reCAPTCHA validation. Please try again.';
                        console.error('Error verifying reCAPTCHA:', error);
                        this.isSubmitting = false; // Reset the flag
                    });
            } else {
                this.isLoading = false;
                this.errorMessage = 'Failed to verify reCAPTCHA. Please try again.';
                console.error('reCAPTCHA token not received.');
                this.isSubmitting = false; // Reset the flag
            }
        }
    }
    submitCase() {
        console.log('Submitting case');
        this.isLoading = true;
        this.modal = true;
        this.showWarning = true;
        createAeCase({ caseDetails: this.caseDetails })
            .then(result => {
                console.log('Submit case result:', result);
                this.isSubmitted = true;
                this.submitResult = result;
                if (result.caseNumber) {
                    this.isLoading = false;
                    this.caseNumber = result.caseNumber;
                    this.isCaseNumber = true;
                } else {
                    this.isLoading = false;
                    console.error('Error:', JSON.stringify(result.errorMessage));
                    this.errorMessage = 'Sorry, there was a technical issue, and your request did not get processed. You can refresh your browser and attempt to resubmit the Adverse Event report via the Merck AE Reporting Self-Service Portal, or please call the Merck National Service Center at 1-800-672-6372 for further assistance.';
                }
                this.isSubmitting = false; // Reset the flag
                console.log('Token after Submitting:', JSON.stringify(this.token));
                console.log('Case Details after Submitting:', JSON.stringify(this.caseDetails));
            })
            .catch(error => {
                this.isLoading = false;
                console.error('Error Submit-> ' + JSON.stringify(error));
                this.errorMessage = 'There was an error processing your request. Please try again.';
                this.isSubmitting = false; // Reset the flag
            });
    }
    

    // handleSubmit() {
    //     // document.dispatchEvent(new CustomEvent('grecaptchaExecute', {'detail': {action: 'submit'}}));
    
    //     console.log('Case Details in review stage:', JSON.stringify(this.caseDetails));
    //     this.modal = true;
    //     this.showWarning = true;
    //     this.isLoading = true;
    //     createAeCase({ caseDetails: this.caseDetails })
    //         .then(result => {
    //             this.isSubmitted = true;
    //             this.submitResult = result;
    //             if (result.isSuccess) {
    //                 // console.log('Success! Case Id:', result.caseId, 'Case Number:', result.caseNumber);
    //                 this.isLoading = false;
    //                 this.caseNumber = result.caseNumber;
    //                 this.isCaseNumber = true;
    //             } else {
    //                 this.isLoading = false;
    //                 console.error('Error:', result.errorMessage);
    //                 this.errorMessage = 'Sorry, there was a technical issue, and your request did not get processed. You can refresh your browser and attempt to resubmit the Adverse Event report via the Merck AE Reporting Self-Service Portal, or please call the Merck National Service Center at 1-800-672-6372 for further assistance.';
    //             }
    //         })
    //         .catch(error => {
    //             console.log('Error Submit-> ' + JSON.stringify(error));
    //         })
    // }

    setDefaultValues(obj) {
        for (let key in obj) {
            if (obj[key] && typeof obj[key] === 'object') {
                this.setDefaultValues(obj[key]);
            } else if (obj[key] === undefined || obj[key] === '') {
                obj[key] = 'Not Available';
            }
        }
        return obj;
    }

    updatePspOtherFields(fieldName, fieldValue) {
        if (fieldValue === 'Other') {
            switch (fieldName) {
                case 'PSPProgramName':
                    this.isProgramOtherFieldDisabled = true;
                    break;
                case 'PSPCompany':
                    this.isCompanyOtherFieldDisabled = true;
                    break;
                case 'PSPNumber':
                    this.isNumberOtherFieldDisabled = true;
                    break;
            }
        }
    }

    handleFileDownload(event) {
        const fileId = event.currentTarget.dataset.id;
        const file = this.uploadedFilesList.find(f => f.id === fileId);

        if (file && file.base64) {
            this.base64ToDownloadLink(file.base64, file.filename);
        }
    }
    base64ToDownloadLink(base64, filename) {
        const binaryString = window.atob(base64);
        const binaryLen = binaryString.length;
        const binaryData = new Uint8Array(binaryLen);

        for (let i = 0; i < binaryLen; i++) {
            binaryData[i] = binaryString.charCodeAt(i);
        }
        const blob = new Blob([binaryData], { type: 'application/octet-stream' });
        const blobURL = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = blobURL;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

}