/**
* @author - SK, Merck & Co.,Inc.
* @className - MRK_SampleLimitExtractScheduledReport.cls
* @description - Report Scheduled which sent Data in Excel
* @createdate - Oct 27th, 2020
*
*/
public class MRK_SampleLimitExtractScheduledReport{

public void SampleLimitExtract_report(){
    string header =  'Sample Limit Name,CreatedDate,ISID,Limit Quantity,Disbursed Quantity,Remaining Quantity \n';
    string finalstr = header ;
    List<string> uniqueIds = new List<string>(); 
    Set<string> uniquename = new Set<string>(); 
    for(Sample_Limit_vod__c flist : [select Id,Name, Owner.alias,CreatedDate,Product_vod__r.SAM_Product_ID_MRK__c from Sample_Limit_vod__c where Start_Date_vod__c= THIS_MONTH ORDER BY Owner.alias ASC,CreatedDate DESC]) 
    {
    if(!uniquename.contains(flist.Product_vod__r.SAM_Product_ID_MRK__c+flist.Owner.alias))
    {
        uniquename.add(flist.Product_vod__r.SAM_Product_ID_MRK__c+flist.Owner.alias);
        uniqueIds.add(flist.Id);
    }
    }
    for(Sample_Limit_vod__c sl: [select Name, CreatedDate, Owner.alias, Limit_Quantity_vod__c,Disbursed_Quantity_vod__c,Remaining_Quantity_vod__c 
                                 from Sample_Limit_vod__c 
                                 where Id IN : uniqueIds])
   // for(Sample_Limit_vod__c sl:  [select Name,CreatedDate,Product_vod__r.SAM_Product_ID_MRK__c,Owner.Alias from Sample_Limit_vod__c where Start_Date_vod__c= THIS_MONTH])
    {
           string recordString = sl.Name +','+sl.CreatedDate+','+sl.Owner.Alias+','+sl.Limit_Quantity_vod__c+ ','+sl.Disbursed_Quantity_vod__c+ ','+sl.Remaining_Quantity_vod__c +'\n';
           finalstr = finalstr +recordString;
    }
    Messaging.EmailFileAttachment csvAttc = new Messaging.EmailFileAttachment();
    blob csvBlob = Blob.valueOf(finalstr);
    string csvname= 'Sample Limit Schedule File2.csv';
    csvAttc.setFileName(csvname);
    csvAttc.setBody(csvBlob);
    Messaging.SingleEmailMessage email =new Messaging.SingleEmailMessage();
    String[] toAddresses = new list<string> {'andrew.lagner@merck.com','leslie_thompson-strack@merck.com','leslie_thompson-strack@merck.com','rachel.reale@merck.com','michaela_buck@merck.com','morgen.westfall@merck.com'};
    String[] ccAddresses = new list<string> {'GHHVeeva_MSOTeam@merck.com'};
    String subject ='Daily Sample Limit Extract File Two';
    email.setSubject(subject);
    email.setToAddresses( toAddresses );
    email.setCcAddresses( ccAddresses );
    email.setPlainTextBody('Hi Team,' +'\n' +'Please find the attached Sample Limit Extract for TODAY.'+'\n' + '\n' +'Daily Sample Limit Extract File 2' +'\n'+'Generated By: US VEEVA ADMIN TODAY 05:00 AM' +'\n' +'Thanks & Regards,' +'\n' +'MS&O Team');
    email.setFileAttachments(new Messaging.EmailFileAttachment[]{csvAttc});
    Messaging.SendEmailResult [] r = Messaging.sendEmail(new Messaging.SingleEmailMessage[] {email});
   }
}