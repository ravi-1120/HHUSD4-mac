/**
* @author - SK, Merck & Co.,Inc.
* @className - MRK_ScheduledReport.cls
* @description - Report Scheduled which sent Data in Excel
* @createdate - June 20th, 2017
*
*/
public class MRK_ScheduledReport{

public void run_report(){
    List<Address_vod__c> acclist = [select Account_vod__r.FirstName , Account_vod__r.LastName , Account_vod__r.Credentials_vod__c ,Name , Address_line_2_vod__c ,City_vod__c ,State_vod__c  ,Zip_vod__c from Address_vod__c where Primary_vod__c = true and Account_vod__r.State_Gov_Employee_MRK__c = true];
    
    string header = 'Account First Name, Account Last Name , Credential ,Address Line 1, Address Line 2, City , State ,Zip \n';
    string finalstr = header ;
    for(Address_vod__c a: acclist)
    {
           string recordString = a.Account_vod__r.FirstName +','+a.Account_vod__r.LastName +','+a.Account_vod__r.Credentials_vod__c+','+a.Name + ','+a.Address_line_2_vod__c + ','+a.City_vod__c + ','+a.State_vod__c + ','+a.Zip_vod__c +'\n';
           finalstr = finalstr +recordString;
    }
    Messaging.EmailFileAttachment csvAttc = new Messaging.EmailFileAttachment();
    blob csvBlob = Blob.valueOf(finalstr);
    string csvname= 'State_Gov_Accounts_with_Prim_Address.csv';
    csvAttc.setFileName(csvname);
    csvAttc.setBody(csvBlob);
    Messaging.SingleEmailMessage email =new Messaging.SingleEmailMessage();
    String[] toAddresses = new list<string> {'ruth_kratz@merck.com','shubham.kumar.dapakara@merck.com'};
    String subject ='State Gov Accounts with Prim Address';
    email.setSubject(subject);
    email.setToAddresses( toAddresses );
    email.setPlainTextBody('Hi Ruth,' +'\n' +'Please find the attached State Employee report of current month.'+'\n' + '\n' +'State Gov Accounts with Prim Address' +'\n'+'Generated By: US VEEVA ADMIN TODAY 09:00 AM' +'\n' +'Thanks & Regards,' +'\n' +'MS&O Team');
    email.setFileAttachments(new Messaging.EmailFileAttachment[]{csvAttc});
    Messaging.SendEmailResult [] r = Messaging.sendEmail(new Messaging.SingleEmailMessage[] {email});
   }
}